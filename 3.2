
--Sahar Fadul
ALTER TABLE Orders ADD CONSTRAINT FK_Orders_UserID FOREIGN KEY (UserID) REFERENCES UserBase(UserID);
 
ALTER TABLE Orders ADD CONSTRAINT FK_Orders_ProductCode FOREIGN KEY (ProductCode) REFERENCES ProductList(ProductCode);
 
ALTER TABLE Reviews ADD CONSTRAINT FK_Reviews_ProductCode FOREIGN KEY (ProductCode) REFERENCES ProductList(ProductCode);
 
ALTER TABLE Reviews ADD CONSTRAINT FK_Reviews_UserID FOREIGN KEY (UserID) REFERENCES UserBase(UserID);
 
ALTER TABLE UserLibrary ADD CONSTRAINT FK_UserLibrary_UserID FOREIGN KEY (UserID) REFERENCES UserBase(UserID);
 
ALTER TABLE UserLibrary ADD CONSTRAINT FK_UserLibrary_ProductCode FOREIGN KEY (ProductCode) REFERENCES ProductList(ProductCode);

DESC USERBASE;

SELECT FIRSTNAME || ' ' || LASTNAME AS FULLNAME,
       USERNAME
FROM USERBASE
WHERE FLOOR(MONTHS_BETWEEN(SYSDATE, BIRTHDAY) / 12) >= 18;

SELECT MAX(LENGTH(USERNAME)) AS MAX_LENGTH,
       ROUND(AVG(LENGTH(USERNAME)), 2) AS AVG_LENGTH
FROM USERBASE;

SELECT QUESTION
FROM SECURITYQUESTION
WHERE QUESTION LIKE 'What is%'
   OR QUESTION LIKE 'What was%';

SELECT PRODUCTCODE,
       MIN(RATING) AS LOWEST_RATING,
       COUNT(*) AS REVIEW_COUNT
FROM REVIEWS
GROUP BY PRODUCTCODE
ORDER BY REVIEW_COUNT DESC;

SELECT PRODUCTCODE,
       COUNT(*) AS USER_COUNT
FROM WISHLIST
WHERE POSITION = 1
GROUP BY PRODUCTCODE;

SELECT USERID,
       SUM(TOTALAMOUNT) AS TOTAL_SPENT
FROM ORDERS
GROUP BY USERID
ORDER BY TOTAL_SPENT DESC;

SELECT USERID,
       SUM(PRICE) AS TOTAL_SPENT
FROM ORDERS
GROUP BY USERID
ORDER BY TOTAL_SPENT DESC;

SELECT PURCHASEDATE,
       SUM(PRICE) AS GROSS_PROFIT
FROM ORDERS
GROUP BY PURCHASEDATE
ORDER BY GROSS_PROFIT DESC;

SELECT *
FROM (
    SELECT PRODUCTCODE,
           SUM(HOURSPLAYED) AS TOTAL_HOURS
    FROM USERLIBRARY
    GROUP BY PRODUCTCODE
    ORDER BY TOTAL_HOURS DESC
)
WHERE ROWNUM <= 5;

CREATE OR REPLACE VIEW USER_INFRACTION_COUNT AS
SELECT USERID,
       COUNT(*) AS INFRACTION_COUNT
FROM INFRACTIONS
GROUP BY USERID
ORDER BY INFRACTION_COUNT DESC;

CREATE OR REPLACE VIEW USER_RULE_INFRACTIONS AS
SELECT USERID,
       RULENUM,
       COUNT(*) AS RULE_BREAK_COUNT
FROM INFRACTIONS
GROUP BY USERID, RULENUM
ORDER BY USERID;

SELECT RULENUM,
       PENALTY,
       COUNT(*) AS PENALTY_COUNT
FROM INFRACTIONS
GROUP BY RULENUM, PENALTY;

SELECT table_name
FROM user_tables
WHERE table_name LIKE '%TICKET%';

SELECT USERID,
       FIRSTNAME,
       LASTNAME
FROM USERBASE
WHERE LOWER(PASSWORD) LIKE '%' || LOWER(FIRSTNAME) || '%'
   OR LOWER(PASSWORD) LIKE '%' || LOWER(LASTNAME) || '%';


SELECT PUBLISHER,
       ROUND(AVG(PRICE), 2) AS AVG_PRICE
FROM PRODUCTLIST
GROUP BY PUBLISHER
ORDER BY PUBLISHER;

CREATE OR REPLACE VIEW DISCOUNTED_OLD_PRODUCTS AS
SELECT PRODUCTNAME,
       PRICE * 0.75 AS DISCOUNTED_PRICE
FROM PRODUCTLIST
WHERE RELEASEDATE <= ADD_MONTHS(SYSDATE, -60);

SELECT GENRE,
       MAX(PRICE) AS MAX_PRICE,
       MIN(PRICE) AS MIN_PRICE
FROM PRODUCTLIST
GROUP BY GENRE;

CREATE OR REPLACE VIEW RECENT_CHATLOG AS
SELECT *
FROM CHATLOG
WHERE DATESENT BETWEEN SYSDATE - 7 AND SYSDATE;

CREATE OR REPLACE VIEW RECENT_PENALTIES AS
SELECT USERID,
       DATEASSIGNED,
       PENALTY
FROM INFRACTIONS
WHERE PENALTY IS NOT NULL
  AND DATEASSIGNED >= ADD_MONTHS(SYSDATE, -1);
